@page "/screenshot"
@rendermode InteractiveServer
@using AutomationTool.Services
@using AutomationTool.Models
@using Microsoft.JSInterop
@inject IScreenshotService ScreenshotService
@inject IScriptStorageService ScriptStorage
@inject IJSRuntime JSRuntime
@inject ILogger<Screenshot> _logger
@inject NavigationManager Navigation

<PageTitle>Screenshot Capture</PageTitle>

<h1>üì∏ Screenshot Capture</h1>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Capture Options</h5>
                
                <div class="mb-3">
                    <label class="form-label">Capture Mode</label>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="captureMode" id="fullScreen" checked @onchange="() => SetCaptureMode(CaptureMode.FullScreen)">
                        <label class="btn btn-outline-primary" for="fullScreen">Full Screen</label>

                        <input type="radio" class="btn-check" name="captureMode" id="region" @onchange="() => SetCaptureMode(CaptureMode.Region)">
                        <label class="btn btn-outline-primary" for="region">Select Region</label>
                    </div>
                </div>

                @if (currentMode == CaptureMode.Region)
                {
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">X</label>
                            <input type="number" class="form-control" @bind="regionX" min="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Y</label>
                            <input type="number" class="form-control" @bind="regionY" min="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Width</label>
                            <input type="number" class="form-control" @bind="regionWidth" min="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Height</label>
                            <input type="number" class="form-control" @bind="regionHeight" min="1">
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-secondary" @onclick="StartRegionSelection">
                                üñ±Ô∏è Select Region on Screen (Browser)
                            </button>
                            <button class="btn btn-outline-primary" @onclick="StartDesktopRegionSelection" disabled="@isSelectingRegion">
                                @if (isSelectingRegion)
                                {
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <text> Selecting Desktop Region...</text>
                                }
                                else
                                {
                                    <text>üñ•Ô∏è Select Region on Desktop (Full Screen)</text>
                                }
                            </button>
                        </div>
                    </div>
                }

                <div class="mb-3">
                    <label class="form-label">Template Name (Optional)</label>
                    <input type="text" class="form-control" @bind="templateName" placeholder="Enter name to save as template">
                </div>

                <div class="d-grid gap-2 d-md-flex">
                    <button class="btn btn-primary" @onclick="CaptureScreenshot" disabled="@isCapturing">
                        @if (isCapturing)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <text> Capturing...</text>
                        }
                        else
                        {
                            <text>üì∑ Capture Screenshot</text>
                        }
                    </button>
                    
                    @if (capturedImageData != null)
                    {
                        <div class="btn-group">
                            @if (!string.IsNullOrEmpty(templateName))
                            {
                                <button class="btn btn-success" @onclick="SaveAsTemplate" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        <text> Saving...</text>
                                    }
                                    else
                                    {
                                        <text>üíæ Save as Template</text>
                                    }
                                </button>
                            }
                            <button class="btn btn-outline-primary" @onclick="SaveAsTemplateAndCreateScript" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <text> Creating...</text>
                                }
                                else
                                {
                                    <text>üéØ Save Template & Create Script</text>
                                }
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="alert @statusClass alert-dismissible fade show mt-3" role="alert">
                @statusMessage
                <button type="button" class="btn-close" @onclick="ClearStatus"></button>
            </div>
        }
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Screen Information</h5>
                <p><strong>Screen Resolution:</strong> @screenBounds.Width x @screenBounds.Height</p>
                
                @if (currentMode == CaptureMode.Region)
                {
                    <p><strong>Capture Region:</strong> @regionWidth x @regionHeight</p>
                    <p><strong>Position:</strong> (@regionX, @regionY)</p>
                }
                
                @if (capturedImageData != null)
                {
                    <p><strong>Last Capture:</strong> @lastCaptureTime.ToString("yyyy-MM-dd HH:mm:ss")</p>
                    <p><strong>Image Size:</strong> @(capturedImageData.Length / 1024) KB</p>
                }
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">Quick Actions</h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary" @onclick="SetCommonRegion" data-region="center">
                        üìç Center (800x600)
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="SetTopLeftRegion">
                        üìç Top Left (400x300)
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="SetBottomRightRegion">
                        üìç Bottom Right (400x300)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@if (capturedImageData != null)
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Captured Image Preview</h5>
                    <div class="text-center">
                        <img src="data:image/png;base64,@Convert.ToBase64String(capturedImageData)" 
                             alt="Captured screenshot" 
                             class="img-fluid" 
                             style="max-height: 400px; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                    </div>
                    
                    <div class="mt-3 text-center">
                        <button class="btn btn-outline-primary" @onclick="DownloadImage">
                            üíæ Download Image
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private enum CaptureMode
    {
        FullScreen,
        Region
    }

    private CaptureMode currentMode = CaptureMode.FullScreen;
    private int regionX = 0;
    private int regionY = 0;
    private int regionWidth = 800;
    private int regionHeight = 600;
    private string templateName = string.Empty;
    private byte[]? capturedImageData;
    private DateTime lastCaptureTime;
    private System.Drawing.Rectangle screenBounds;
    private bool isCapturing = false;
    private bool isSaving = false;
    private bool isSelectingRegion = false;
    private string statusMessage = string.Empty;
    private string statusClass = string.Empty;
    private DotNetObjectReference<Screenshot>? selfRef;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _logger?.LogInformation("Screenshot component initializing...");
            
            screenBounds = ScreenshotService.GetScreenBounds();
            _logger?.LogInformation("Screen bounds: {Width}x{Height}", screenBounds.Width, screenBounds.Height);
            
            // Set default region to center of screen
            regionX = (screenBounds.Width - regionWidth) / 2;
            regionY = (screenBounds.Height - regionHeight) / 2;
            
            _logger?.LogInformation("Default region set to: ({X}, {Y}, {Width}x{Height})", regionX, regionY, regionWidth, regionHeight);
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error during component initialization");
            ShowStatus($"Error initializing: {ex.Message}", "alert-danger");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            selfRef = DotNetObjectReference.Create(this);
        }
    }

    private void SetCaptureMode(CaptureMode mode)
    {
        currentMode = mode;
        StateHasChanged();
    }


    private async Task CaptureScreenshot()
    {
        try
        {
            isCapturing = true;
            ClearStatus();
            ShowStatus("Starting screenshot capture...", "alert-info");
            StateHasChanged();

            _logger?.LogInformation("Starting screenshot capture. Mode: {Mode}", currentMode);

            if (currentMode == CaptureMode.FullScreen)
            {
                _logger?.LogInformation("Capturing full screen...");
                capturedImageData = await ScreenshotService.CaptureFullScreenAsync();
                _logger?.LogInformation("Full screen captured. Image size: {Size} bytes", capturedImageData?.Length ?? 0);
                ShowStatus("Full screen captured successfully!", "alert-success");
            }
            else
            {
                _logger?.LogInformation("Capturing region: ({X}, {Y}, {Width}x{Height})", regionX, regionY, regionWidth, regionHeight);
                capturedImageData = await ScreenshotService.CaptureRegionAsync(regionX, regionY, regionWidth, regionHeight);
                _logger?.LogInformation("Region captured. Image size: {Size} bytes", capturedImageData?.Length ?? 0);
                ShowStatus($"Region ({regionX}, {regionY}, {regionWidth}x{regionHeight}) captured successfully!", "alert-success");
            }

            lastCaptureTime = DateTime.Now;
            _logger?.LogInformation("Screenshot capture completed successfully");
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error capturing screenshot");
            ShowStatus($"Error capturing screenshot: {ex.Message}", "alert-danger");
            
            // Also log the full exception details
            var fullError = ex.ToString();
            if (ex.InnerException != null)
            {
                fullError += $"\nInner Exception: {ex.InnerException}";
            }
            _logger?.LogError("Full exception details: {FullError}", fullError);
        }
        finally
        {
            isCapturing = false;
            StateHasChanged();
        }
    }

    private async Task SaveAsTemplate()
    {
        if (capturedImageData == null || string.IsNullOrWhiteSpace(templateName))
            return;

        try
        {
            isSaving = true;
            ClearStatus();
            StateHasChanged();

            var region = currentMode == CaptureMode.FullScreen 
                ? new ScreenRegion { X = 0, Y = 0, Width = screenBounds.Width, Height = screenBounds.Height }
                : new ScreenRegion { X = regionX, Y = regionY, Width = regionWidth, Height = regionHeight };

            var template = new TemplateImage
            {
                Name = templateName,
                ImageData = capturedImageData,
                CaptureRegion = region.ToRectangle(),
                MatchThreshold = 0.8
            };

            await ScriptStorage.SaveTemplateImageAsync(template);
            ShowStatus($"Template '{templateName}' saved successfully!", "alert-success");
            templateName = string.Empty;
        }
        catch (Exception ex)
        {
            ShowStatus($"Error saving template: {ex.Message}", "alert-danger");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task SaveAsTemplateAndCreateScript()
    {
        if (capturedImageData == null)
        {
            ShowStatus("Please capture a screenshot first", "alert-warning");
            return;
        }

        try
        {
            isSaving = true;
            ClearStatus();
            ShowStatus("Creating template and script...", "alert-info");
            StateHasChanged();

            // Generate template name if not provided
            var finalTemplateName = string.IsNullOrWhiteSpace(templateName) 
                ? $"Template_{DateTime.Now:yyyyMMdd_HHmmss}"
                : templateName;

            var region = currentMode == CaptureMode.FullScreen 
                ? new ScreenRegion { X = 0, Y = 0, Width = screenBounds.Width, Height = screenBounds.Height }
                : new ScreenRegion { X = regionX, Y = regionY, Width = regionWidth, Height = regionHeight };

            // Save template image
            var template = new TemplateImage
            {
                Name = finalTemplateName,
                ImageData = capturedImageData,
                CaptureRegion = region.ToRectangle(),
                MatchThreshold = 0.8
            };

            var templateId = await ScriptStorage.SaveTemplateImageAsync(template);
            
            // Create a script that uses this template
            var script = new AutomationScript
            {
                Name = $"Auto Script - {finalTemplateName}",
                Description = $"Automatically generated script to find and click '{finalTemplateName}'",
                Steps = new List<ScriptStep>
                {
                    new ScriptStep
                    {
                        Name = $"Find and click {finalTemplateName}",
                        Type = "condition",
                        Order = 1,
                        Conditions = new List<ScriptCondition>
                        {
                            new ScriptCondition
                            {
                                Type = "image_found",
                                Parameters = new Dictionary<string, object>
                                {
                                    {"templateImageId", templateId},
                                    {"threshold", 0.8}
                                }
                            }
                        },
                        Actions = new List<ScriptAction>
                        {
                            new ScriptAction
                            {
                                Type = "click",
                                Parameters = new Dictionary<string, object> 
                                { 
                                    {"x", region.X + region.Width / 2}, 
                                    {"y", region.Y + region.Height / 2} 
                                }
                            }
                        }
                    }
                }
            };

            await ScriptStorage.SaveScriptAsync(script);

            ShowStatus($"Template '{finalTemplateName}' and automation script created successfully!", "alert-success");
            templateName = string.Empty;

            // Navigate to scripts page to see the new script
            await Task.Delay(2000); // Show success message briefly
            Navigation.NavigateTo("/scripts");
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error creating template and script");
            ShowStatus($"Error creating template and script: {ex.Message}", "alert-danger");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task DownloadImage()
    {
        if (capturedImageData == null) return;

        try
        {
            var fileName = $"screenshot_{DateTime.Now:yyyyMMdd_HHmmss}.png";
            var base64 = Convert.ToBase64String(capturedImageData);
            
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "data:image/png;base64," + base64);
            ShowStatus("Image download started!", "alert-info");
        }
        catch (Exception ex)
        {
            ShowStatus($"Error downloading image: {ex.Message}", "alert-danger");
        }
    }

    private void SetCommonRegion()
    {
        regionWidth = 800;
        regionHeight = 600;
        regionX = (screenBounds.Width - regionWidth) / 2;
        regionY = (screenBounds.Height - regionHeight) / 2;
        StateHasChanged();
    }

    private void SetTopLeftRegion()
    {
        regionWidth = 400;
        regionHeight = 300;
        regionX = 50;
        regionY = 50;
        StateHasChanged();
    }

    private void SetBottomRightRegion()
    {
        regionWidth = 400;
        regionHeight = 300;
        regionX = screenBounds.Width - regionWidth - 50;
        regionY = screenBounds.Height - regionHeight - 50;
        StateHasChanged();
    }

    private void ShowStatus(string message, string cssClass)
    {
        statusMessage = message;
        statusClass = cssClass;
        StateHasChanged();
    }

    private void ClearStatus()
    {
        statusMessage = string.Empty;
        statusClass = string.Empty;
    }

    private async Task StartRegionSelection()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("startRegionSelection", selfRef);
        }
        catch (Exception ex)
        {
            ShowStatus($"Failed to start region selection: {ex.Message}", "alert-danger");
        }
    }

    private async Task StartDesktopRegionSelection()
    {
        try
        {
            isSelectingRegion = true;
            ClearStatus();
            ShowStatus("Opening desktop region selector... Click and drag to select an area on your entire desktop.", "alert-info");
            StateHasChanged();

            _logger?.LogInformation("Starting desktop region selection...");
            
            var selectedRegion = await ScreenshotService.SelectDesktopRegionAsync();
            
            if (selectedRegion.HasValue)
            {
                var rect = selectedRegion.Value;
                regionX = rect.X;
                regionY = rect.Y;
                regionWidth = rect.Width;
                regionHeight = rect.Height;
                
                ShowStatus($"Desktop region selected: ({regionX}, {regionY}, {regionWidth}x{regionHeight})", "alert-success");
                _logger?.LogInformation("Desktop region selected and applied: ({X}, {Y}, {Width}x{Height})", regionX, regionY, regionWidth, regionHeight);
            }
            else
            {
                ShowStatus("Desktop region selection cancelled", "alert-warning");
                _logger?.LogInformation("Desktop region selection was cancelled");
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error during desktop region selection");
            ShowStatus($"Error selecting desktop region: {ex.Message}", "alert-danger");
        }
        finally
        {
            isSelectingRegion = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnRegionSelected(int x, int y, int width, int height)
    {
        regionX = x;
        regionY = y;
        regionWidth = width;
        regionHeight = height;
        ShowStatus($"Region selected: ({regionX}, {regionY}, {regionWidth}x{regionHeight})", "alert-info");
        StateHasChanged();
    }

    public void Dispose()
    {
        selfRef?.Dispose();
    }
}

<script>
    window.downloadFile = (filename, dataUrl) => {
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // Enhanced full-desktop overlay for selecting a region with better visibility
    window.startRegionSelection = (dotnetRef) => {
        try {
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.left = '0';
            overlay.style.top = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.background = 'rgba(0,0,0,0.3)';
            overlay.style.cursor = 'crosshair';
            overlay.style.zIndex = '999999';
            
            // Add instructions
            const instructions = document.createElement('div');
            instructions.style.position = 'fixed';
            instructions.style.top = '20px';
            instructions.style.left = '50%';
            instructions.style.transform = 'translateX(-50%)';
            instructions.style.background = 'rgba(0,0,0,0.8)';
            instructions.style.color = 'white';
            instructions.style.padding = '10px 20px';
            instructions.style.borderRadius = '5px';
            instructions.style.fontSize = '14px';
            instructions.style.zIndex = '1000000';
            instructions.style.pointerEvents = 'none';
            instructions.textContent = 'Click and drag to select a region. Press ESC to cancel.';
            overlay.appendChild(instructions);

            const selection = document.createElement('div');
            selection.style.position = 'fixed';
            selection.style.border = '3px solid #0d6efd';
            selection.style.background = 'rgba(13,110,253,0.2)';
            selection.style.pointerEvents = 'none';
            selection.style.display = 'none';
            selection.style.boxShadow = '0 0 10px rgba(13,110,253,0.5)';

            document.body.appendChild(overlay);
            document.body.appendChild(selection);

            let startX = 0, startY = 0, endX = 0, endY = 0, isSelecting = false;

            const onMouseDown = (e) => {
                isSelecting = true;
                startX = e.clientX;
                startY = e.clientY;
                selection.style.left = `${startX}px`;
                selection.style.top = `${startY}px`;
                selection.style.width = '0px';
                selection.style.height = '0px';
                selection.style.display = 'block';
            };

            const onMouseMove = (e) => {
                if (!isSelecting) return;
                endX = e.clientX;
                endY = e.clientY;
                const left = Math.min(startX, endX);
                const top = Math.min(startY, endY);
                const width = Math.abs(endX - startX);
                const height = Math.abs(endY - startY);
                selection.style.left = `${left}px`;
                selection.style.top = `${top}px`;
                selection.style.width = `${width}px`;
                selection.style.height = `${height}px`;
                
                // Show coordinates during selection
                if (width > 5 && height > 5) {
                    coordsDisplay.style.display = 'block';
                    coordsDisplay.textContent = `Position: (${left}, ${top}) Size: ${width} √ó ${height}`;
                }
            };

            // Add coordinates display
            const coordsDisplay = document.createElement('div');
            coordsDisplay.style.position = 'fixed';
            coordsDisplay.style.bottom = '20px';
            coordsDisplay.style.left = '50%';
            coordsDisplay.style.transform = 'translateX(-50%)';
            coordsDisplay.style.background = 'rgba(0,0,0,0.8)';
            coordsDisplay.style.color = 'white';
            coordsDisplay.style.padding = '5px 15px';
            coordsDisplay.style.borderRadius = '3px';
            coordsDisplay.style.fontSize = '12px';
            coordsDisplay.style.zIndex = '1000000';
            coordsDisplay.style.pointerEvents = 'none';
            coordsDisplay.style.display = 'none';
            overlay.appendChild(coordsDisplay);

            const cleanup = () => {
                overlay.removeEventListener('mousedown', onMouseDown);
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
                window.removeEventListener('keydown', onKeyDown);
                if (selection && selection.parentNode) selection.parentNode.removeChild(selection);
                if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
            };

            // ESC key support
            const onKeyDown = (e) => {
                if (e.key === 'Escape') {
                    cleanup();
                }
            };

            const onMouseUp = async (e) => {
                if (!isSelecting) { cleanup(); return; }
                isSelecting = false;
                endX = e.clientX;
                endY = e.clientY;
                const left = Math.min(startX, endX);
                const top = Math.min(startY, endY);
                const width = Math.abs(endX - startX);
                const height = Math.abs(endY - startY);

                const dpr = window.devicePixelRatio || 1;
                const screenOffsetX = (window.screenX !== undefined ? window.screenX : window.screenLeft) || 0;
                const screenOffsetY = (window.screenY !== undefined ? window.screenY : window.screenTop) || 0;

                const absX = Math.round((screenOffsetX + left) * dpr);
                const absY = Math.round((screenOffsetY + top) * dpr);
                const absW = Math.round(width * dpr);
                const absH = Math.round(height * dpr);

                cleanup();

                if (absW > 2 && absH > 2 && dotnetRef && dotnetRef.invokeMethodAsync) {
                    try { await dotnetRef.invokeMethodAsync('OnRegionSelected', absX, absY, absW, absH); } catch {}
                }
            };

            overlay.addEventListener('mousedown', onMouseDown);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
            window.addEventListener('keydown', onKeyDown);
        } catch (err) {
            console.error('startRegionSelection error', err);
        }
    };
</script>